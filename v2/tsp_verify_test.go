package ncanode_test

import (
	"testing"

	"github.com/danikarik/ncanode-go/v2"
	"github.com/stretchr/testify/require"
)

func TestTSPVerify(t *testing.T) {
	client, err := ncanode.NewClient("http://127.0.0.1:14579")
	require.NoError(t, err)

	testCases := []struct {
		Name string
		CMS  string
	}{
		{
			Name: "Default",
			CMS:  `MIIGCgYJKoZIhvcNAQcCoIIF+zCCBfcCAQMxDjAMBggqgw4DCgEDAQUAMIGBBgsqhkiG9w0BCRABBKByBHAwbgIBAQYIKoMOAwMCBgEwMDAMBggqgw4DCgEDAQUABCAIpej0s+OwH6xeU68Wbl47yc6B6yRJqo10TNQf\/z9ytgIU9o\/gkAAMwzNzK82Q1RFqjI86oSUYDzIwMjAwOTA2MTYzMDUxWgIGAXRkQY2\/oIID6jCCA+YwggOQoAMCAQICFFWSMI9yDWj\/ydlN47Rqas53D9HJMA0GCSqDDgMKAQEBAgUAMFMxCzAJBgNVBAYTAktaMUQwQgYDVQQDDDvSsNCb0KLQotCr0pog0JrQo9OY0JvQkNCd0JTQq9Cg0KPQqNCrINCe0KDQotCQ0JvQq9KaIChHT1NUKTAeFw0xOTEyMTIwNTIyMDVaFw0yMjEyMTEwNTIyMDVaMIIBEjEUMBIGA1UEAwwLVFNBIFNFUlZJQ0UxGDAWBgNVBAUTD0lJTjc2MTIzMTMwMDMxMzELMAkGA1UEBhMCS1oxHDAaBgNVBAcME9Cd0KPQoC3QodCj0JvQotCQ0J0xHDAaBgNVBAgME9Cd0KPQoC3QodCj0JvQotCQ0J0xfTB7BgNVBAoMdNCQ0JrQptCY0J7QndCV0KDQndCe0JUg0J7QkdCp0JXQodCi0JLQniAi0J3QkNCm0JjQntCd0JDQm9Cs0J3Qq9CVINCY0J3QpNCe0KDQnNCQ0KbQmNCe0J3QndCr0JUg0KLQldCl0J3QntCb0J7Qk9CY0JgiMRgwFgYDVQQLDA9CSU4wMDA3NDAwMDA3MjgwbDAlBgkqgw4DCgEBAQEwGAYKKoMOAwoBAQEBAQYKKoMOAwoBAwEBAANDAARA7+2hUwL6yz3TtRmGj1zFcrRuDb\/F15QaxBsSf2nkCgEF9G5HMrfCyet6qMIZKhcRp7ZLSlZvvxfV5Y6h2nGHMqOCAWkwggFlMBYGA1UdJQEB\/wQMMAoGCCsGAQUFBwMIMA8GA1UdIwQIMAaABFtqc+kwHQYDVR0OBBYEFO2P\/eayaKY5p0MWNEhQ3TOSAppkMFgGA1UdHwRRME8wTaBLoEmGImh0dHA6Ly9jcmwucGtpLmdvdi5rei9uY2FfZ29zdC5jcmyGI2h0dHA6Ly9jcmwxLnBraS5nb3Yua3ovbmNhX2dvc3QuY3JsMFwGA1UdLgRVMFMwUaBPoE2GJGh0dHA6Ly9jcmwucGtpLmdvdi5rei9uY2FfZF9nb3N0LmNybIYlaHR0cDovL2NybDEucGtpLmdvdi5rei9uY2FfZF9nb3N0LmNybDBjBggrBgEFBQcBAQRXMFUwLwYIKwYBBQUHMAKGI2h0dHA6Ly9wa2kuZ292Lmt6L2NlcnQvbmNhX2dvc3QuY2VyMCIGCCsGAQUFBzABhhZodHRwOi8vb2NzcC5wa2kuZ292Lmt6MA0GCSqDDgMKAQEBAgUAA0EA9Ca5fBDDygwfCxDFSXxuIG9ppdJVLyI4cJjm+HmqpNdYUt7c\/nGqDf1PwNGU+M+aG7j1h8NZuyUjhGx6uFtkZDGCAW4wggFqAgEBMGswUzELMAkGA1UEBhMCS1oxRDBCBgNVBAMMO9Kw0JvQotCi0KvSmiDQmtCj05jQm9CQ0J3QlNCr0KDQo9Co0Ksg0J7QoNCi0JDQm9Cr0pogKEdPU1QpAhRVkjCPcg1o\/8nZTeO0amrOdw\/RyTAMBggqgw4DCgEDAQUAoIGYMBoGCSqGSIb3DQEJAzENBgsqhkiG9w0BCRABBDAcBgkqhkiG9w0BCQUxDxcNMjAwOTA2MTYzMDUxWjArBgsqhkiG9w0BCRACDDEcMBowGDAWBBR7gM+qyuxNgPDQbpw3HTYl1EVkbTAvBgkqhkiG9w0BCQQxIgQg3NjMhxkV9PeUAcbT\/VmzapBqfxz34Blycg5mWiD89wYwDQYJKoMOAwoBAQECBQAEQC0qgyst0V1CZY9dD1AWOS9psgd0epiVS2PigL9MiOOPfdtuvYkK1a4+\/I28itcRq\/YGror90J4nX9Elo0+VYc4=`,
		},
	}

	for _, tc := range testCases {
		t.Run(tc.Name, func(t *testing.T) {
			resp, err := client.TSPVerify(tc.CMS)
			require.NoError(t, err)
			require.Equal(t, ncanode.GOST34311, resp.Result.TSPHashAlgorithm)
			require.Equal(t, "f68fe090000cc333732bcd90d5116a8c8f3aa125", resp.Result.SerialNumber)
			require.Equal(t, "08a5e8f4b3e3b01fac5e53af166e5e3bc9ce81eb2449aa8d744cd41fff3f72b6", resp.Result.Hash)
			require.False(t, resp.Result.GenTime.IsZero())
			require.Equal(t, "1.2.398.3.3.2.6.1", resp.Result.Policy)
		})
	}
}
